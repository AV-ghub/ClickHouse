–ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏–∑ Postgres –≤ ClickHouse —á–µ—Ä–µ–∑ PeerDB.

## üìã –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ PostgreSQL

```sql
-- –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ PostgreSQL (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∫ superuser)
-- 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
CREATE USER peerdb_replication_user WITH PASSWORD 'secure_password' REPLICATION;

-- 2. –ù–∞–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö)
GRANT CONNECT ON DATABASE your_database TO peerdb_replication_user;
GRANT USAGE ON SCHEMA public TO peerdb_replication_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO peerdb_replication_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO peerdb_replication_user;

-- 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–≤ postgresql.conf –∏–ª–∏ ALTER SYSTEM)
ALTER SYSTEM SET wal_level = logical;
ALTER SYSTEM SET max_replication_slots = 10; -- –∏–ª–∏ –±–æ–ª—å—à–µ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ —Ç–∞–±–ª–∏—Ü
ALTER SYSTEM SET max_wal_senders = 10;
SELECT pg_reload_conf();

-- 4. –ü–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞/–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞ - —Å–æ–∑–¥–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
CREATE PUBLICATION peerdb_pub FOR ALL TABLES; -- –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
-- –ò–õ–ò –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü:
CREATE PUBLICATION peerdb_pub FOR TABLE users, orders, products;

-- 5. –ü—Ä–æ–≤–µ—Ä–∫–∞
SELECT * FROM pg_publication;
SELECT * FROM pg_replication_slots;
```

### 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ClickHouse

```sql
-- –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ ClickHouse
-- 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è PeerDB (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
CREATE USER peerdb_user IDENTIFIED WITH sha256_password BY 'ch_password';
GRANT ALL ON *.* TO peerdb_user WITH GRANT OPTION;

-- 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
CREATE DATABASE IF NOT EXISTS analytics;

-- 3. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å PeerDB —Å–æ–∑–¥–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PeerDB

```sql
-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PeerDB (–ø–æ—Ä—Ç 9900 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
-- 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–∏—Ä–∞ –¥–ª—è PostgreSQL
CREATE PEER pg_peer FROM POSTGRES WITH (
    host = 'postgres-host',
    port = 5432,
    user = 'peerdb_replication_user',
    password = 'secure_password',
    database = 'your_database',
    sslmode = 'require' -- –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
);

-- 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–∏—Ä–∞ –¥–ª—è ClickHouse  
CREATE PEER ch_peer FROM CLICKHOUSE WITH (
    host = 'clickhouse-host',
    port = 9000,
    user = 'peerdb_user',
    password = 'ch_password',
    database = 'analytics'
);

-- 3. –°–æ–∑–¥–∞–Ω–∏–µ mirror –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
CREATE MIRROR pg_to_ch_mirror
FROM pg_peer TO ch_peer
FOR TABLES (public.users, public.orders, public.products)
WITH (
    do_initial_copy = true,
    snapshot_num_rows_per_partition = 500000,
    snapshot_max_parallel_workers = 4,
    snapshot_num_tables_in_parallel = 2,
    refresh_interval = '30s'
);

-- 4. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ - —Å–æ–∑–¥–∞–Ω–∏–µ mirror –¥–ª—è –≤—Å–µ–π –ë–î
CREATE MIRROR pg_to_ch_full_mirror
FROM pg_peer TO ch_peer
FOR ALL TABLES
WITH (
    do_initial_copy = true
);
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

```sql
-- 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ mirror
SELECT mirror_name, status, error_message 
FROM peerdb_mirrors 
WHERE mirror_name = 'pg_to_ch_mirror';

-- 2. –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ mirror
SELECT * FROM peerdb_mirror_detailed_status;

-- 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
SELECT * FROM peerdb_mirror_initial_copy_operations;

-- 4. –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞/–≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ mirror
UPDATE peerdb_mirrors 
SET paused = true 
WHERE mirror_name = 'pg_to_ch_mirror';

UPDATE peerdb_mirrors 
SET paused = false 
WHERE mirror_name = 'pg_to_ch_mirror';

-- 5. –£–¥–∞–ª–µ–Ω–∏–µ mirror
DROP MIRROR pg_to_ch_mirror;
```

### 5. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç

```bash
#!/bin/bash
# automate_replication.sh

echo "Step 1: Setting up PostgreSQL..."
psql -h postgres-host -U postgres -d your_database -f setup_postgres.sql

echo "Step 2: Setting up ClickHouse..."
clickhouse-client -h clickhouse-host -u default --password -f setup_clickhouse.sql

echo "Step 3: Creating peers and mirrors..."
psql "port=9900 host=localhost user=peerdb password=peerdb" -f setup_peerdb.sql

echo "Step 4: Starting monitoring..."
# –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
watch -n 10 'psql "port=9900 host=localhost user=peerdb password=peerdb" -c "SELECT mirror_name, status FROM peerdb_mirrors;"'
```

### 6. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

```sql
-- 1. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
-- 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–¥–µ—Ä–∂–µ–∫ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
SELECT 
    mirror_name,
    last_refresh_started_at,
    last_refresh_completed_at,
    (EXTRACT(EPOCH FROM (last_refresh_completed_at - last_refresh_started_at))) as lag_seconds
FROM peerdb_mirrors;

-- 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ DDL –∏–∑–º–µ–Ω–µ–Ω–∏–π
-- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç–∏–Ω–≥ –Ω–∞ DDL –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ PostgreSQL
-- –ò–º–µ—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –≤ ClickHouse

-- 4. –û—á–∏—Å—Ç–∫–∞ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
-- –í PostgreSQL –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:
SELECT pg_drop_replication_slot('peerdb_slot_name');
DROP PUBLICATION peerdb_pub;
DROP USER peerdb_replication_user;
```

## üîÑ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

1. **PostgreSQL**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ü—Ä–∞–≤–∞ ‚Üí –ü–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Üí –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ ‚Üí –ü—É–±–ª–∏–∫–∞—Ü–∏—è
2. **ClickHouse**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
3. **PeerDB**: Pg Peer ‚Üí CH Peer ‚Üí Mirror
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –°—Ç–∞—Ç—É—Å ‚Üí –ü—Ä–æ–≥—Ä–µ—Å—Å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è ‚Üí –ó–∞–¥–µ—Ä–∂–∫–∏
